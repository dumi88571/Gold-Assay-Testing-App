{% extends "base.html" %}

{% block title %}Trend Analysis - Gold Assay Analyzer{% endblock %}

{% block content %}
<div class="card shadow-lg border-0 mb-4" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);">
    <div class="card-header border-0 bg-transparent py-3 d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-chart-line me-2"></i>Grade Trends</h5>
            <p class="text-muted small mb-0">Historical analysis of gold grade over time</p>
        </div>
        <div class="btn-group shadow-sm">
            <a href="?days=30" class="btn btn-sm btn-outline-primary {% if days == 30 %}active{% endif %}">30 Days</a>
            <a href="?days=60" class="btn btn-sm btn-outline-primary {% if days == 60 %}active{% endif %}">60 Days</a>
            <a href="?days=90" class="btn btn-sm btn-outline-primary {% if days == 90 %}active{% endif %}">90 Days</a>
        </div>
    </div>
    <div class="card-body p-4">
        <div style="height: 400px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-lg border-0" style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);">
            <div class="card-header border-0 bg-transparent py-3">
                <h5 class="mb-0 fw-bold text-secondary"><i class="fas fa-table me-2"></i>Daily Statistics</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 text-uppercase text-muted small fw-bold">Date</th>
                                <th class="text-uppercase text-muted small fw-bold text-center">Samples</th>
                                <th class="text-uppercase text-muted small fw-bold">Avg Grade</th>
                                <th class="text-uppercase text-muted small fw-bold">Min Grade</th>
                                <th class="text-uppercase text-muted small fw-bold">Max Grade</th>
                                <th class="pe-4 text-uppercase text-muted small fw-bold">7-Day MA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for d in trend_data %}
                            <tr>
                                <td class="ps-4 fw-bold text-dark">{{ d.date }}</td>
                                <td class="text-center"><span class="badge bg-light text-dark border">{{ d.count
                                        }}</span></td>
                                <td class="font-monospace text-primary fw-bold">{{ "%.3f"|format(d.avg) }}</td>
                                <td class="font-monospace text-muted">{{ "%.3f"|format(d.min) }}</td>
                                <td class="font-monospace text-muted">{{ "%.3f"|format(d.max) }}</td>
                                <td class="pe-4 font-monospace text-info">{% if d.moving_avg %}{{
                                    "%.3f"|format(d.moving_avg) }}{% else %}-{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const trendData = JSON.parse('{{ trend_data|tojson|safe }}');

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: trendData.map(d => d.date),
            datasets: [
                {
                    label: 'Average Grade',
                    data: trendData.map(d => d.avg),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.3,
                    fill: true
                },
                {
                    label: 'Max Grade',
                    data: trendData.map(d => d.max),
                    borderColor: '#27ae60',
                    borderDash: [5, 5],
                    tension: 0.3,
                    pointRadius: 0
                },
                {
                    label: 'Min Grade',
                    data: trendData.map(d => d.min),
                    borderColor: '#e74c3c',
                    borderDash: [5, 5],
                    tension: 0.3,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Grade (g/t)' }
                }
            }
        }
    });
</script>
{% endblock %}