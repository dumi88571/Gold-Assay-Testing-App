{% extends "base.html" %}

{% block title %}Calibration - Gold Assay Analyzer{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-4">
        <div class="card shadow-lg border-0 h-100"
            style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);">
            <div class="card-header border-0 bg-transparent py-3">
                <h5 class="mb-0 fw-bold text-primary"><i class="fas fa-plus-circle me-2"></i>New Calibration</h5>
                <p class="text-muted small mb-0">Record instrument maintenance</p>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('calibration.add') }}">
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Instrument ID</label>
                        <input type="text" name="instrument_id" class="form-control bg-light" required
                            placeholder="e.g., AAS-001">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Calibration Type</label>
                        <select name="calibration_type" class="form-select bg-light">
                            <option value="daily">Daily Check</option>
                            <option value="weekly">Weekly Maintenance</option>
                            <option value="monthly">Monthly Service</option>
                            <option value="maintenance">Ad-hoc Maintenance</option>
                            <option value="emergency">Emergency Repair</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-uppercase small fw-bold text-muted">Standard Used</label>
                        <select name="standard_used" class="form-select bg-light">
                            {% for std in standards %}
                            <option value="{{ std.standard_name }}">{{ std.standard_name }} ({{ std.gold_grade }} g/t)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label text-uppercase small fw-bold text-muted">Drift Check</label>
                            <input type="number" name="drift_check" class="form-control bg-light" step="0.001"
                                value="1.0" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-uppercase small fw-bold text-muted">R² Value</label>
                            <input type="number" name="r_squared" class="form-control bg-light" step="0.0001" min="0.99"
                                max="1.0" value="0.9995" required>
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label text-uppercase small fw-bold text-muted">Slope</label>
                            <input type="number" name="slope" class="form-control bg-light" step="0.001" value="1.0"
                                required>
                        </div>
                        <div class="col-6">
                            <label class="form-label text-uppercase small fw-bold text-muted">Intercept</label>
                            <input type="number" name="intercept" class="form-control bg-light" step="0.001" value="0.0"
                                required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label text-uppercase small fw-bold text-muted">Notes</label>
                        <textarea name="notes" class="form-control bg-light" rows="2"
                            placeholder="Optional remarks..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-gradient-primary w-100 py-2 shadow-sm fw-bold">
                        <i class="fas fa-save me-2"></i>Record Calibration
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        {% if last_calibration %}
        <div class="card border-0 shadow-lg mb-4 text-white overflow-hidden position-relative"
            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="position-absolute top-0 end-0 p-4 opacity-25">
                <i class="fas fa-check-circle fa-5x"></i>
            </div>
            <div class="card-body p-4 position-relative z-1">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="fw-bold mb-1">System Status: Operational</h5>
                        <p class="mb-3 opacity-90">Instrument calibrated and ready for analysis.</p>
                        <div class="d-flex gap-4 small opacity-90">
                            <div><i class="fas fa-clock me-2"></i>Last: {{
                                last_calibration.calibration_date.strftime('%Y-%m-%d %H:%M') if
                                last_calibration.calibration_date else '-' }}</div>
                            <div><i class="fas fa-calendar-day me-2"></i>Days Since: {{ days_since }}</div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="display-6 fw-bold">{{ "%.5f"|format(last_calibration.r_squared) }}</div>
                        <small class="text-uppercase opacity-75">R² Score</small>
                    </div>
                </div>
            </div>
            {% if days_since > 1 %}
            <div class="card-footer bg-warning border-0 text-dark fw-bold">
                <i class="fas fa-exclamation-triangle me-2"></i>Calibration is stale (>24h). Please perform daily check.
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div class="card shadow-lg border-0 h-100"
            style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);">
            <div class="card-header border-0 bg-transparent py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-secondary"><i class="fas fa-history me-2"></i>History</h5>
                <a href="{{ url_for('calibration.history') }}" class="btn btn-sm btn-outline-primary">View Full Log</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 text-uppercase text-muted small fw-bold">Date</th>
                                <th class="text-uppercase text-muted small fw-bold">Instrument</th>
                                <th class="text-uppercase text-muted small fw-bold">Type</th>
                                <th class="text-uppercase text-muted small fw-bold">Drift</th>
                                <th class="text-uppercase text-muted small fw-bold">R²</th>
                                <th class="pe-4 text-end text-uppercase text-muted small fw-bold">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for cal in calibrations %}
                            <tr>
                                <td class="ps-4 text-dark fw-bold">{{ cal.calibration_date.strftime('%Y-%m-%d') if
                                    cal.calibration_date else '-' }}</td>
                                <td class="text-muted small">{{ cal.instrument_id }}</td>
                                <td><span class="badge bg-light text-dark border">{{ cal.calibration_type|title
                                        }}</span></td>
                                <td class="font-monospace text-muted">{{ "%.4f"|format(cal.drift_check) }}</td>
                                <td class="font-monospace text-primary fw-bold">{{ "%.5f"|format(cal.r_squared) }}</td>
                                <td class="pe-4 text-end">
                                    {% if cal.passed %}
                                    <span
                                        class="badge bg-success bg-opacity-10 text-success border border-success px-2 py-1">PASS</span>
                                    {% else %}
                                    <span
                                        class="badge bg-danger bg-opacity-10 text-danger border border-danger px-2 py-1">FAIL</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}